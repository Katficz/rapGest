extends layout 

block content
    div.container
        div.row
            div.col-xl-10.offset-xl-1.col-l-12
                h3.h3.text-center Lista awarii
                button.btn.btn-outline-warning#newFailure(type="button" onclick='addFBtn()') Dodaj Awarię

                div.accordion#failureAccordion.mt-2(data-raport=myRaport data-coworkers=coWorkers data-loggedInUser=loggedInUser.fullname)
                    
                    if myRaport.failure.length!=0
                        
                        each failure, index in myRaport.failure

                            div.card#card(value=failure._id)
                                
                                div.card-header.gestamp-bg-color
                                    h2.mb-0 
                                        button.btn.btn-link.btn-block.text-left.collapsed(type="button" data-toggle="collapse" data-target='#collapse'+index aria-expanded="true" aria-controls="collapseOne" style="color: white") Awaria num #{index + 1} Dodana przez: #{failure.author.fullname}
                                
                                div.collapse(data-parent="#failureAccordion" id='collapse'+index)
                                    
                                    div.card-body
                                        
                                        form(data-rapId=myRaport._id data-failureId=failure._id)
                                            
                                            div.form-row#startUpOption(data-failure=failure)
                                                div.form-group.col-4
                                                    label Linia produkcyjna
                                                    select.prodLineOption.form-control(name="prodLine")
                                                        option(value='Dowolna' selected) -
                                                        each prodLineIterate in prodLines 
                                                            if failure.prodLine
                                                                option(value=prodLineIterate._id selected=(failure.prodLine.name==prodLineIterate.name)) #{prodLineIterate.name}   
                                                            else
                                                                option(value=prodLineIterate._id) #{prodLineIterate.name}
                                                              
                                                div.form-group.col-4
                                                    label Operacja
                                                    select.operationOption.form-control
                                                        option(value='Dowolna' selected) -
                                                        each operation in operations
                                                            if failure.operation
                                                                option(value=operation._id selected=(failure.operation.name==operation.name)) #{operation.name}  
                                                            else
                                                                option(value=operation._id) #{operation.name}

                                                div.form-group.col-4
                                                    label Typ urządzenia
                                                    select.deviceTypeOption.form-control
                                                        option(value='Dowolna' selected) -
                                                        each deviceTypeIt in deviceTypes
                                                            if failure.deviceType
                                                                option(value=deviceTypeIt._id selected=(failure.deviceType.name==deviceTypeIt.name)) #{deviceTypeIt.name}  
                                                            else
                                                                option(value=deviceTypeIt._id) #{deviceTypeIt.name}

                                                div.form-group.col-4
                                                    label Urządzenie
                                                    select.deviceOption.form-control
                                                        option(value='Dowolna' selected) -
                                                        each deviceIt in devices
                                                            if failure.device
                                                                option(value=deviceIt._id selected=(failure.device.name==deviceIt.name)) #{deviceIt.name}
                                                            else
                                                                option(value=deviceIt._id) #{deviceIt.name}
                                            div.form-row
                                                div.form-group.col-4
                                                    label(for="startDate") Godzina rozpoczęcia
                                                    - var nSD = new Date(failure.startDate)
                                                    input.form-control#startDate(type='time', name='startDate' value=(("0" + nSD.getHours()).slice(-2)+':'+("0" + nSD.getMinutes()).slice(-2)) disabled=(failure.author._id.toString()==loggedInUser._id.toString()?false:true))
                                                div.form-group.col-4
                                                    label(for="endDate") Godzina zakończenia
                                                    - var nED = new Date(failure.endDate)
                                                    input.form-control#endDate(type='time', name='endDate' value=(("0" + nED.getHours()).slice(-2)+':'+("0" + nED.getMinutes()).slice(-2)) disabled=(failure.author._id.toString()==loggedInUser._id.toString()?false:true))
                                                div.form-group.col-4
                                                    p Efekt
                                                    input.mx-1(type="radio" name="efect" value="OK" checked=(failure.effect===true) disabled=(failure.author._id.toString()==loggedInUser._id.toString()?false:true))
                                                    label.mr-2(for="efect") OK
                                                    input.mx-1(type="radio" name="efect" value="NOK" checked=(failure.effect===false) disabled=(failure.author._id.toString()==loggedInUser._id.toString()?false:true))
                                                    label(for="efect") NOK

                                            div.form-row
                                                div.form-group.col-12
                                                    label(for="orderNum") Numer zlecenia
                                                    textarea.form-control#orderNum(type='text' name='orderNum' disabled=(failure.author._id.toString()==loggedInUser._id.toString()?false:true)) #{failure.orderNum}

                                            div.form-row
                                                div.form-group.col-12
                                                    label(for="cause") Przyczyna
                                                    textarea.text-break.form-control#cause(type='text', name='cause' disabled=(failure.author._id.toString()==loggedInUser._id.toString()?false:true)) #{failure.cause}

                                            div.form-row
                                                div.form-group.col-12
                                                    label(for="diagnostics") Diagnostyka
                                                    textarea.form-control#diagnostics(type='text', name='diagnostics' disabled=(failure.author._id.toString()==loggedInUser._id.toString()?false:true)) #{failure.diagnostics}

                                            div.form-row
                                                div.form-group.col-12
                                                    label(for="actions") Wykonane akcje
                                                    textarea.form-control#actions(type='text', name='actions' disabled=(failure.author._id.toString()==loggedInUser._id.toString()?false:true)) #{failure.action}

                                            div.form-row
                                                div.form-group.col-6
                                                    label(for="usedParts") Wykorzystane części
                                                    textarea.form-control#usedParts(type='text', name='usedParts' disabled=(failure.author._id.toString()==loggedInUser._id.toString()?false:true)) #{failure.usedParts}
                                                div.form-group.col-6
                                                    label(for="missingParts") Brakujące części
                                                    textarea.form-control#missingParts(type='text', name='missingParts' disabled=(failure.author._id.toString()==loggedInUser._id.toString()?false:true)) #{failure.missingParts}

                                            div.form-row
                                                div.form-group.col-12
                                                    p Pracujący przy awarii:
                                                        ul.nice-shifts-border.list-unstyled
                                                                each employee in coWorkers
                                                                    div(class='aa'+failure._id.toString() data-emplo=employee._id)
                                                                        li
                                                                            input.mr-1.collabsCheckBox(type='checkbox' name='nonCollabs' data-employeeId=employee._id.toString() disabled=(failure.author._id.toString()==loggedInUser._id.toString()?false:true))
                                                                            label(for='nonCollabs') #{employee.name} #{employee.surname}
                                            div.form-row
                                                div.form-group.col-12
                                                    button.btn.btn-outline-danger#deleteFailure(type="button" onclick='deleteSomeFail(this)' disabled=(failure.author._id.toString()==loggedInUser._id.toString()?false:true)) Usuń
                                                    button.btn.btn-outline-success.float-right#saveFailure.float-right(type="button" onclick='saveSomeFailure(this)' disabled=(failure.author._id.toString()==loggedInUser._id.toString()?false:true)) Zapisz

                    div.card#card(style="display: none")
                        div.card-header.gestamp-bg-color
                            h2.mb-0 
                                button.btn.btn-link.btn-block.text-left(type="button" data-toggle="collapse" data-target="#collapse1" aria-expanded="true" aria-controls="collapseOne" style="color: white") Awaria num 1 #{loggedInUser.fullname}
                        div#collapse1.collapse(data-parent="#failureAccordion")
                            div.card-body
                                form(data-rapId=myRaport._id)
                                    div.form-row
                                        div.form-group.col-4
                                            label Linia produkcyjna
                                            select.prodLineOption.form-control(name="prodLine")
                                                option(value='Dowolna' selected) -
                                                each prodLineIterate in prodLines 
                                                        option(value=prodLineIterate._id) #{prodLineIterate.name}
                                                        
                                        div.form-group.col-4
                                            label Operacja
                                            select.operationOption.form-control
                                                option(value='Dowolna' selected) -
                                                each operation in operations
                                                        option(value=operation._id) #{operation.name}

                                        div.form-group.col-4
                                            label Typ urządzenia
                                            select.deviceTypeOption.form-control
                                                option(value='Dowolna' selected) -
                                                each deviceTypeIt in deviceTypes
                                                        option(value=deviceTypeIt._id) #{deviceTypeIt.name}

                                        div.form-group.col-4
                                            label Urządzenie
                                            select.deviceOption.form-control
                                                option(value='Dowolna' selected) -
                                                each deviceIt in devices
                                                    option(value=deviceIt._id) #{deviceIt.name}
                                    div.form-row
                                        div.form-group.col-4
                                            label(for="startDate") Godzina rozpoczęcia
                                            input.form-control#startDate(type='time', name='startDate' required)
                                        div.form-group.col-4
                                            label(for="endDate") Godzina zakończenia
                                            input.form-control#endDate(type='time', name='endDate' required)
                                        div.form-group.col-4
                                            p Efekt
                                            input.mx-1(type="radio" name="efect" value="OK")
                                            label.mr-2(for="efect") OK
                                            input.mx-1(type="radio" name="efect" value="NOK")
                                            label(for="efect") NOK

                                    div.form-row
                                        div.form-group.col-12
                                            label(for="orderNum") Numer zlecenia
                                            input.form-control#orderNum(type='text', name='orderNum')

                                    div.form-row
                                        div.form-group.col-12
                                            label(for="cause") Przyczyna
                                            textarea.form-control#cause(type='text', name='cause')

                                    div.form-row
                                        div.form-group.col-12
                                            label(for="diagnostics") Diagnostyka
                                            textarea.form-control#diagnostics(type='text', name='diagnostics')

                                    div.form-row
                                        div.form-group.col-12
                                            label(for="actions") Wykonane akcje
                                            textarea.form-control#actions(type='text', name='actions')

                                    div.form-row
                                        div.form-group.col-6
                                            label(for="usedParts") Wykorzystane części
                                            textarea.form-control#usedParts(type='text', name='usedParts')
                                        div.form-group.col-6
                                            label(for="missingParts") Brakujące części
                                            textarea.form-control#missingParts(type='text', name='missingParts')
                                    div.form-row
                                        div.form-group.col-12
                                            p Współpracujący przy awarii:
                                                ul.nice-shifts-border.list-unstyled
                                                    each employee in coWorkers
                                                        div(style="width:100%")
                                                            li
                                                                input.mr-1.collabsCheckBox(type='checkbox' data-employeeId=employee._id.toString() name='techCoWorker' value=employee._id)
                                                                label(for='techCoWorker') #{employee.name} #{employee.surname}          


                                    div.form-row
                                        div.form-group.col-12
                                            button.btn.btn-outline-danger#deleteFailure(type="button" name="deleteDiv" onclick="deleteSomeFail(this)") Usuń
                                            button.btn.btn-outline-success.float-right#saveFailure.float-right(type="button" onclick='saveSomeFailure(this)') Zapisz

    div#snackbar 

    
    script.
        raport = !{JSON.stringify(myRaport)}
        const activateLink = document.querySelector('#seconSectionActive')
        activateLink.className+=" active"
        const activateSubMenu = document.querySelector('#myRaportSubMenu')
        activateSubMenu.className+=" active"

        const bigDiv = document.querySelector('#failureAccordion')

        //startupforcollaborators
        var failures = JSON.parse(bigDiv.dataset.raport).failure
        for(var i = 0;i<failures.length;i++) {
            var divyDoPokazania = document.querySelectorAll('div.aa'+failures[i]._id)
            for(var j = 0;j<divyDoPokazania.length;j++) {
                for(var k = 0;k<failures[i].collaborators.length;k++) {
                    if(divyDoPokazania[j].dataset.emplo==failures[i].collaborators[k]._id) {
                        divyDoPokazania[j].firstChild.firstChild.checked = true
                    }
                }
            }
        };

        var failureNum = bigDiv.childElementCount -1

        function addFBtn() {
            failureNum++
            var newDiv = bigDiv.lastChild.cloneNode(true)
            fullName = bigDiv.dataset.loggedinuser.toString()
            newDiv.firstChild.firstChild.lastChild.textContent = 'Awaria num '+ failureNum + ' ' + fullName
            newDiv.firstChild.firstChild.lastChild.dataset.target = '#collapse'+failureNum
            newDiv.lastChild.id = 'collapse'+failureNum
            newDiv.style.display = 'flex'
            bigDiv.appendChild(newDiv)
        }

        function deleteSomeFail(button) {
            var form = button.parentNode.parentNode.parentNode
            if(form.dataset.failureid) {
                var accordionDiv = button.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode
                var deleteMeDiv = button.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode
                fetch('/api/usun-awarie/'+form.dataset.rapid, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({failureId: form.dataset.failureid})
                    
                })
                .then(function(response) {
                console.log(response)

                return response.json();
                })
                .then(function(json) {
                    if(json.message) {
                        alert(json.message)
                    }
                    else{
                    accordionDiv.removeChild(deleteMeDiv)
                    var snackBar = document.getElementById("snackbar");
                    snackBar.className = "show";
                    snackBar.textContent = 'Pomyślnie usunięto awarię!'
                    setTimeout(function(){ snackBar.className = snackBar.className.replace("show", ""); }, 3000);                     }
                })
                .catch((err) => {
                    alert(err.message)
                })

                }
            if(!form.dataset.failureid) {
                var accordionDiv = button.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode
                var deleteMeDiv = button.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode
                accordionDiv.removeChild(deleteMeDiv)
            }
        }

        // This function takes time string(eg. "12:30") and turns it into date obj
        function timeToDate(time){
            time = time.split(':')
            today = new Date(raport.date)
            today.setHours(time[0],time[1],0,0)
            return today
        }
        function saveSomeFailure(button) {
            var form = button.parentNode.parentNode.parentNode
            //- prodLineId = form.childNodes[0].childNodes[0].childNodes[1].selectedOptions[0].value
            //- deviceTypeId = form.childNodes[0].childNodes[1].childNodes[1].selectedOptions[0].value
            //- deviceId = form.childNodes[0].childNodes[2].childNodes[1].selectedOptions[0].value
            prodLineId = form.querySelector('.prodLineOption').value
            deviceTypeId = form.querySelector('.deviceTypeOption').value
            deviceId = form.querySelector('.deviceOption').value
            operationId = form.querySelector('.operationOption').value

            startDate = form.childNodes[1].childNodes[0].childNodes[1].value
            startDate = timeToDate(startDate)
            endDate = form.childNodes[1].childNodes[1].childNodes[1].value
            endDate = timeToDate(endDate)

            var effect
            if(form.childNodes[1].childNodes[2].childNodes[1].checked) {effect = true}
            if(form.childNodes[1].childNodes[2].childNodes[3].checked) {effect = false}

            orderNum = form.childNodes[2].childNodes[0].childNodes[1].value

            cause = form.childNodes[3].childNodes[0].childNodes[1].value

            diagnostics = form.childNodes[4].childNodes[0].childNodes[1].value

            action = form.childNodes[5].childNodes[0].childNodes[1].value

            usedParts = form.childNodes[6].childNodes[0].childNodes[1].value
            missingParts = form.childNodes[6].childNodes[1].childNodes[1].value
            
            collaborators = []
            collabsCheck = form.querySelectorAll('.collabsCheckBox')
            for(let i = 0;i<collabsCheck.length;i++) {
                if(collabsCheck[i].checked) {
                    collaborators.push(collabsCheck[i].dataset.employeeid) // inputy
                }
            }

            let formBody = {
                failureId: form.dataset.failureid,
                startDate: startDate,
                endDate: endDate,
                orderNum: orderNum,
                cause: cause,
                diagnostics: diagnostics,
                effect: effect,
                action: action,
                usedParts: usedParts,
                missingParts: missingParts,
                collaborators: collaborators
            }

            if (operationId !== 'Dowolna')
                formBody.operation = operationId
            if (prodLineId !== 'Dowolna')
                formBody.prodLine = prodLineId
            if (deviceTypeId !== 'Dowolna')
                formBody.deviceType = deviceTypeId
            if (deviceId !== 'Dowolna')
                formBody.device = deviceId


            fetch('/api/zapisz-awarie/'+form.dataset.rapid, {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formBody)
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(json) {
                if(json.message) {
                    alert(json.mesage)
                }
                else{
                    var snackBar = document.getElementById("snackbar");
                    snackBar.className = "show";
                    snackBar.textContent = 'Pomyślnie zapisano awarię!'
                    setTimeout(function(){ snackBar.className = snackBar.className.replace("show", ""); }, 3000);                 form.dataset.failureid = json._id
                }
            })
            .catch((err) => {
                alert(err.message)
            })
        }
    
    if errors
        ul
            for error in errors
                li!= error.msg
